<p-messages [(value)]="this.errorMessages" [closable]="false" [showTransitionOptions]="'0ms'" [hideTransitionOptions]="'0ms'"></p-messages>
<div class="row mt-2 mb-2">
    <div class="col-md-12">
        <ul class="nav nav-pills nav-fill nav-light">
            <li class="nav-item">
                <span class="nav-link" style="cursor: pointer;" (click)="displayIndex = 0" [ngClass]="{'active': displayIndex === 0, 'text-primary': displayIndex !== 0}">
                  FITS
                </span>
            </li>
            <li class="nav-item">
                <span class="nav-link" style="cursor: pointer;" (click)="displayIndex = 1" [ngClass]="{'active': displayIndex === 1, 'text-primary': displayIndex !== 1}">
                  VeraPDF
                  <ng-container *ngIf="this.verapdfErrorMessages && this.verapdfErrorMessages.length !== 0; else noErrorsTemplate">
                      <span class="badge" [ngClass]="{'badge-warning': !showCompleted,'badge-danger': showCompleted}">{{ this.verapdfErrorMessages.length }}</span>
                  </ng-container>
                  <ng-template #noErrorsTemplate>
                      <ng-container *ngIf="fileReport.veraPdfExecutionOutcome !== 'didNotRun' && fileReport._embedded['verapdf-result'] && fileReport._embedded['verapdf-result'].failedRules !== 0">
                          <span class="badge" [ngClass]="{'badge-warning': !showCompleted,'badge-danger': showCompleted}">{{ fileReport._embedded['verapdf-result'].failedRules }}</span>
                      </ng-container>
                  </ng-template>
                </span>
            </li>
            <li class="nav-item">
                <span class="nav-link" style="cursor: pointer;" (click)="displayIndex = 2" [ngClass]="{'active': displayIndex === 2, 'text-primary': displayIndex !== 2}">
                  Identified Problems <span *ngIf="this.checksPage" class="badge badge-warning">{{ this.failedCount }}</span>
                </span>
            </li>
        </ul>
        <hr>
    </div>
</div>

<div class="row mt-2" *ngIf="displayIndex === 0 && fileReport !== null">
  <div class="col-md-12">
    <h5>Identified Formats</h5>
    <table class="table  table-striped ">
        <thead class="table-light">
          <tr>
            <th>Tool</th>
            <th>Version</th>
            <th>Format</th>
            <th>Mime</th>
            <th>Puid</th>
            <th>Valid</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let fitsResult of this.fileReport._embedded['fits-results']">
            <td class="text-monospace font-weight-bold td-break-all " style="max-width:350px; min-width: 140px;"> {{ fitsResult.tool }}  </td>
            <td> {{ fitsResult.toolVersion }} </td>
            <td> {{ fitsResult.formatName }} </td>
            <td> {{ fitsResult.mime }} </td>
            <td> {{ fitsResult.puid ? fitsResult.puid : '' }} </td>
            <td *ngIf="fitsResult.valid !== null" class="font-weight-bold" [ngClass]="{'text-success' : fitsResult.valid === true, 'text-danger' : fitsResult.valid !== true}">
              <!-- <span style="font-size: 16px;"
               class="badge badge-outcome"
               [ngClass]="{'badge-danger badge-pill' : fitsResult.valid === false, 'badge-success' :  fitsResult.valid === true}" >
                {{ fitsResult.valid === true ? 'Valid' : 'Not Valid' }}
              </span> -->
              {{ fitsResult.valid === true ? 'Valid' : 'Not Valid' }}
            <td *ngIf="fitsResult.valid === null" ></td>
            <!-- <td [ngClass]="{'text-danger' : report.summary.validationOutcome !== 'valid'}"> {{ this.resolveCamelCase(report.summary.validationOutcome) }} </td>
            <td> {{ report.summary.problematicFiles }} </td> -->


          </tr>
        </tbody>
        <tfoot class="text-monospace font-weight-bold text-dark bg-light table-bordered">
          <tr>
            <td colspan="6" class="text-center" >
              {{
                this.fileReport._embedded['fits-results'].length === 0
              ? "No Format Records"
              : this.fileReport._embedded['fits-results'].length + " Format Records"
              }}
            </td>
          </tr>
        </tfoot>
      </table>
  </div>
</div>



<div class="row mt-2" *ngIf="displayIndex === 1 && fileReport !== null">
  <div class="col-md-12">
      <!-- <ng-container *ngIf="fileReport.veraPdfExecutionOutcome === 'didNotRun'; else summaryTemplate">
        VeraPDF did not run
      </ng-container>
      <ng-template #summaryTemplate>
        <ng-container *ngIf="fileReport._embedded['verapdf-result']; else noRecordTemplate">
         <h5>Summary</h5>
         <p-messages [(value)]="this.verapdfErrorMessages" [closable]="false" [showTransitionOptions]="'0ms'" [hideTransitionOptions]="'0ms'"></p-messages>
         <div class="table-responsive ">
            <table  class="table table-striped ">
                <thead class="table-light">
                    <tr>
                      <th>Execution Outcome</th>
                      <th>Validation Profile</th>
                      <th>Compliant</th>

                      <th>Passed Rules</th>
                      <th>Failed Rules</th>
                    </tr>
                  </thead>
                  <tbody class="bg-light">
                    <td>{{ fileReport._embedded['verapdf-result'].executionError === false ? 'Success' : 'Error' }}</td>
                    <td>{{ fileReport._embedded['verapdf-result'].validationProfile }}</td>
                    <td>{{ fileReport._embedded['verapdf-result'].compliant }}</td>

                    <td>{{ fileReport._embedded['verapdf-result'].passedRules }}</td>
                    <td>{{ fileReport._embedded['verapdf-result'].failedRules }}</td>



                  </tbody>
            </table>
          </div>
        </ng-container>
        <ng-template #noRecordTemplate>
          No Result
        </ng-template>


      </ng-template> -->

      <h5>Summary</h5>
         <p-messages [(value)]="this.verapdfErrorMessages" [closable]="false" [showTransitionOptions]="'0ms'" [hideTransitionOptions]="'0ms'"></p-messages>
         <div class="table-responsive ">
            <table  class="table table-striped ">
                <thead class="table-light">
                    <tr>
                      <th>Execution Outcome</th>
                      <th>Validation Profile</th>
                      <th>Compliant</th>
                      <!-- <th>Encrypted</th> -->
                      <th>Passed Rules</th>
                      <th>Failed Rules</th>
                    </tr>
                  </thead>
                  <tbody class="bg-light">
                    <ng-container *ngIf="fileReport.veraPdfExecutionOutcome === 'didNotRun'; else didRunTemplate">
                      <td>Did Not Run</td>
                      <td> </td>
                      <td> </td>
                      <td> </td>
                      <td> </td>
                    </ng-container>
                    <ng-template #didRunTemplate>
                      <ng-container *ngIf="fileReport.veraPdfExecutionOutcome === 'failed' ||
                                          (!fileReport._embedded['verapdf-result']) || (fileReport._embedded['verapdf-result'] && fileReport._embedded['verapdf-result'].executionError); else noErrorTemplate">
                        <td>{{ 'Error' }}</td>
                      </ng-container>
                      <ng-template #noErrorTemplate>
                          <td>{{ 'Success' }}</td>
                      </ng-template>
                      <ng-container *ngIf="!fileReport._embedded['verapdf-result']; else resultExistsTemplate">
                          <td> </td>
                          <td> </td>
                          <td> </td>
                          <td> </td>
                      </ng-container>
                      <ng-template #resultExistsTemplate>
                          <td>{{ fileReport._embedded['verapdf-result'].validationProfile }}</td>
                          <td [ngClass]="{'text-success': fileReport._embedded['verapdf-result'].compliant,'text-danger': !fileReport._embedded['verapdf-result'].compliant}" class="font-weight-bold">
                            {{ fileReport._embedded['verapdf-result'].compliant }}
                          </td>
                          <td>{{ fileReport._embedded['verapdf-result'].passedRules }}</td>
                          <td>{{ fileReport._embedded['verapdf-result'].failedRules }}</td>
                      </ng-template>
                    </ng-template>
                  </tbody>
            </table>
          </div>




    <div *ngIf="fileReport._embedded['verapdf-result'] && fileReport._embedded['verapdf-result'].executionError === false && fileReport._embedded['verapdf-result'].compliant === false">

        {{fileReport._embedded['verapdf-result'].errorMessage}}
        <h5 class="mt-3">Failed Rule Checks</h5>
         <div id="accordion" class="mt-4">
           <div class="card mt-1" *ngFor="let assertion of this.assertionsPage._embedded.assertions; let i = index">
             <div class="card-header bg-light">
               <h5 class="mb-0">
                 <button class="btn btn-link  text-primary" aria-expanded="true" (click)=" this.assertionIndex === i ? this.assertionIndex = -1 : this.assertionIndex = i">
                  Specification: {{assertion.specification}}, Clause: {{assertion.clause}}, Test Number: {{assertion.testNumber}}  <span class="badge badge-danger ml-3">{{ assertion.contexts.length + ' Occurences' }} </span>

                 </button>
               </h5>
             </div>

             <div class="collapse" [ngClass]="{'show': this.assertionIndex === i}">
               <div class="card-body">

                 <strong>Description:</strong>
                 <p >
                   {{assertion.description}}
                 </p>
                 <strong>Test:</strong>
                 <p>
                   {{assertion.test}}
                 </p>

                 <strong>Object:</strong>
                 <p >
                   {{assertion.object}}
                 </p>

                 <strong>Locations:</strong>
                 <p *ngFor="let location of assertion.contexts" >
                     {{location}}
                 </p>

               </div>
             </div>
           </div>
           <!-- <div class="card-header text-center bg-light font-weight-bold text-monospace">
             {{this.assertionsPage.totalCount}}  Infringed Rules
           </div> -->
         </div>
         <div *ngIf="this.assertionsPage" class="mt-3">
             <app-paginator [page]="this.assertionsPage" (navigationRequested)="onLoadAssertionsPage($event)"></app-paginator>
         </div>
        </div>




  </div>
</div>



<div class="row mt-2" *ngIf="displayIndex === 2 && fileReport !== null">
  <div class="col-md-12">
    <h5>Failed Rule Checks</h5>
    <p-dropdown class="float-right" [options]="this.options" [(ngModel)]="this.option" id="options" name="options" (onChange)="onChangeCheckTypeFilter($event)"></p-dropdown>
    <table class="table  table-striped ">
        <thead class="table-light">
          <tr>
            <th style="width: 20%">Check Type</th>
            <th style="width: 80%">Error Message</th>
          </tr>
        </thead>
        <tbody *ngIf="this.checksPage">
          <tr *ngFor="let check of this.checksPage._embedded['checks']">
           <td> {{check.checkType === 'fits' ? 'Fits Result Check' :(check.checkType === 'verapdf' ? 'VeraPDF Policy' : 'File Name Check')}} </td>
           <td>{{check.resultMessage}}</td>
          </tr>
        </tbody>
        <tfoot class="text-monospace font-weight-bold text-dark bg-light table-bordered">
          <tr>
            <td colspan="6" class="text-center" >
              {{
                !this.checksPage || this.checksPage.totalCount === 0
              ? "No Failed Checks"
              : this.checksPage.totalCount + " Failed Checks"
              }}
            </td>
          </tr>
        </tfoot>
      </table>
      <div *ngIf="this.checksPage">
        <app-paginator [page]="this.checksPage" (navigationRequested)="onLoadChecksPage($event)"></app-paginator>
      </div>
  </div>
</div>
